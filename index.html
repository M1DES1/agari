<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agario Multiplayer - Menu</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px rgba(102, 126, 234, 0.5); }
            50% { text-shadow: 0 0 20px rgba(102, 126, 234, 0.8); }
        }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }
        
        @keyframes recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .floating-icon {
            animation: float 3s ease-in-out infinite;
        }
        
        .glowing-text {
            animation: glow 2s ease-in-out infinite;
        }
        
        .volume-bar {
            width: 6px;
            background: #4CAF50;
            border-radius: 3px;
            animation: wave 0.5s ease-in-out infinite;
            animation-play-state: paused;
        }
        
        .recording-dot {
            animation: recording 1s infinite;
        }
    </style>
</head>
<body>
    <div class="menu-container">
        <div class="menu-background">
            <div class="bg-circle" style="top: 10%; left: 10%; animation-delay: 0s;"></div>
            <div class="bg-circle" style="top: 60%; left: 80%; animation-delay: 0.5s;"></div>
            <div class="bg-circle" style="top: 30%; left: 70%; animation-delay: 1s;"></div>
            <div class="bg-circle" style="top: 80%; left: 20%; animation-delay: 1.5s;"></div>
            <div class="bg-circle" style="top: 40%; left: 40%; animation-delay: 2s;"></div>
        </div>
        
        <!-- Modal testu mikrofonu z echem -->
        <div id="micTestModal" class="mic-test-modal">
            <div class="mic-test-content">
                <div class="mic-test-header">
                    <div class="mic-test-icon">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <h2>Test Mikrofonu z Echem w Czasie Rzeczywistym</h2>
                    <button class="mic-test-close" id="closeMicTest">&times;</button>
                </div>
                
                <div class="mic-test-body">
                    <div class="test-section">
                        <h3><i class="fas fa-volume-up"></i> Test D≈∫wiƒôku</h3>
                        <p>Kliknij przycisk poni≈ºej aby us≈Çyszeƒá testowy d≈∫wiƒôk:</p>
                        <button id="testSoundBtn" class="test-btn">
                            <i class="fas fa-play"></i> Odtw√≥rz testowy d≈∫wiƒôk
                        </button>
                        <div class="sound-test-result" id="soundTestResult">
                            <i class="fas fa-headphones"></i> Kliknij przycisk aby sprawdziƒá d≈∫wiƒôk
                        </div>
                    </div>
                    
                    <div class="test-section">
                        <h3><i class="fas fa-microphone-alt"></i> Test Mikrofonu z Echem</h3>
                        <p><strong>NOWO≈öƒÜ: Test z echem w czasie rzeczywistym!</strong><br>
                        M√≥w do mikrofonu i us≈Çysz sw√≥j g≈Ços w g≈Ço≈õnikach. U≈ºyj s≈Çuchawek aby uniknƒÖƒá sprzƒô≈ºenia.</p>
                        
                        <div class="mic-test-controls">
                            <button id="startMicTest" class="test-btn test-btn-primary">
                                <i class="fas fa-record-vinyl"></i> Rozpocznij test mikrofonu z echem
                            </button>
                            <button id="stopMicTest" class="test-btn test-btn-secondary" disabled>
                                <i class="fas fa-stop"></i> Zatrzymaj test
                            </button>
                        </div>
                        
                        <!-- Kontrolka g≈Ço≈õno≈õci echa -->
                        <div id="echoVolumeControl" style="display: none; margin-top: 15px; padding: 15px; background: rgba(33, 150, 243, 0.1); border-radius: 10px; border: 1px solid rgba(33, 150, 243, 0.3);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px; color: #2196F3;">
                                    <i class="fas fa-volume-up"></i>
                                    <span style="font-weight: bold;">G≈Ço≈õno≈õƒá echa</span>
                                </div>
                                <span id="volumeValue" style="font-weight: bold; color: #2196F3;">50%</span>
                            </div>
                            <input type="range" id="volumeSlider" min="0" max="100" value="50" style="width: 100%;">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; color: #666; font-size: 0.9rem;">
                                <span>Cicho</span>
                                <span>G≈Ço≈õno</span>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                                <i class="fas fa-info-circle"></i> U≈ºyj s≈Çuchawek aby uniknƒÖƒá sprzƒô≈ºenia
                            </div>
                        </div>
                        
                        <div class="volume-visualizer">
                            <div class="volume-bars" id="volumeBars">
                                <!-- Paski bƒôdƒÖ dodawane dynamicznie -->
                            </div>
                            <div class="volume-info">
                                <div class="volume-level">
                                    <span>Poziom d≈∫wiƒôku:</span>
                                    <strong id="volumeLevel">0%</strong>
                                </div>
                                <div class="mic-status" id="micStatus">
                                    <i class="fas fa-microphone-slash"></i> Mikrofon nieaktywny
                                </div>
                            </div>
                        </div>
                        
                        <div class="mic-test-feedback">
                            <div class="feedback-message" id="feedbackMessage">
                                <i class="fas fa-info-circle"></i> Rozpocznij test aby sprawdziƒá mikrofon
                            </div>
                        </div>
                    </div>
                    
                    <div class="test-instructions">
                        <h4><i class="fas fa-lightbulb"></i> Wskaz√≥wki do testu ECHO:</h4>
                        <ul>
                            <li><strong>Test echo</strong> - m√≥w do mikrofonu, us≈Çyszysz sw√≥j g≈Ços w g≈Ço≈õnikach</li>
                            <li><strong>U≈ºyj suwaka</strong> - dostosuj g≈Ço≈õno≈õƒá echa do swoich preferencji</li>
                            <li><strong>Zielone paski</strong> - pokazujƒÖ aktywno≈õƒá twojego mikrofonu</li>
                            <li><strong>W≈ÇƒÖcz s≈Çuchawki</strong> - aby uniknƒÖƒá sprzƒô≈ºenia zwrotnego</li>
                            <li><strong>Je≈õli nie s≈Çyszysz swojego g≈Çosu</strong> - sprawd≈∫ g≈Ço≈õno≈õƒá systemu</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mic-test-footer">
                    <button id="finishTest" class="finish-btn">
                        <i class="fas fa-check"></i> Zako≈Ñcz test
                    </button>
                    <div class="test-hint">
                        <i class="fas fa-exclamation-triangle"></i>
                        Voice chat dzia≈Ça najlepiej z s≈Çuchawkami!
                    </div>
                </div>
            </div>
        </div>
        
        <div class="menu-box">
            <div class="logo-header">
                <div class="floating-icon" style="font-size: 4rem; margin-bottom: 10px;">
                    üéÆ
                </div>
                <h1 class="glowing-text">AGARIO MULTIPLAYER</h1>
                <div class="game-subtitle">
                    <span class="pulse-dot"></span>
                    <span>VOICE CHAT EDITION</span>
                    <span class="pulse-dot"></span>
                </div>
            </div>
            
            <div class="player-setup">
                <div class="setup-card">
                    <div class="setup-header">
                        <i class="fas fa-user-circle"></i>
                        <h3>Tw√≥j Profil</h3>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-with-icon">
                            <i class="fas fa-user-tag"></i>
                            <input type="text" 
                                   id="nickname" 
                                   placeholder="Wpisz sw√≥j nick..." 
                                   maxlength="15"
                                   value="Gracz">
                        </div>
                        <div class="hint">
                            <i class="fas fa-info-circle"></i>
                            Maksymalnie 15 znak√≥w
                        </div>
                    </div>
                    
                    <div class="color-picker">
                        <div class="picker-header">
                            <i class="fas fa-palette"></i>
                            <h4>Kolor Twojej kulki</h4>
                        </div>
                        <div class="colors">
                            <div class="color-option" style="background: #FF5252" data-color="#FF5252" title="Czerwony">
                                <div class="color-check"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="color-option" style="background: #4CAF50" data-color="#4CAF50" title="Zielony">
                                <div class="color-check"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="color-option" style="background: #2196F3" data-color="#2196F3" title="Niebieski">
                                <div class="color-check"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="color-option" style="background: #FFC107" data-color="#FFC107" title="≈ª√≥≈Çty">
                                <div class="color-check"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="color-option" style="background: #9C27B0" data-color="#9C27B0" title="Fioletowy">
                                <div class="color-check"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="color-option" style="background: #00BCD4" data-color="#00BCD4" title="Cyjan">
                                <div class="color-check"><i class="fas fa-check"></i></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="setup-card">
                    <div class="setup-header">
                        <i class="fas fa-microphone"></i>
                        <h3>Voice Chat</h3>
                    </div>
                    
                    <div class="voice-settings">
                        <div class="voice-permission">
                            <div class="toggle-switch">
                                <input type="checkbox" id="voicePermission" checked>
                                <label for="voicePermission" class="toggle-label">
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-text">W≈ÇƒÖcz Voice Chat</span>
                                </label>
                            </div>
                            <div class="hint voice-hint">
                                <i class="fas fa-headphones"></i>
                                Zalecane u≈ºywanie s≈Çuchawek (unikaj echa)
                            </div>
                        </div>
                        
                        <div class="test-microphone-section">
                            <div class="test-header">
                                <i class="fas fa-vial"></i>
                                <h4>Przetestuj sw√≥j mikrofon z echem</h4>
                            </div>
                            <p class="test-description">
                                <strong>NOWO≈öƒÜ:</strong> Test z echem w czasie rzeczywistym! M√≥w do mikrofonu i s≈Çuchaj swojego g≈Çosu.
                            </p>
                            <button id="openMicTest" class="test-mic-btn">
                                <i class="fas fa-microphone-alt"></i>
                                Testuj mikrofon z echem
                            </button>
                        </div>
                        
                        <div class="voice-info">
                            <div class="info-item">
                                <i class="fas fa-volume-up"></i>
                                <span>Komunikacja g≈Çosowa w czasie rzeczywistym</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-ruler"></i>
                                <span>Zasiƒôg: 20 metr√≥w</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-users"></i>
                                <span>S≈Çyszysz tylko graczy w zasiƒôgu</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="playBtn" class="play-btn">
                <i class="fas fa-play-circle"></i>
                <span class="btn-text">ROZPOCZNIJ GRƒò</span>
                <div class="btn-glow"></div>
            </button>
            
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-microphone-alt"></i>
                    </div>
                    <h4>Voice Chat 20m</h4>
                    <p>Rozmawiaj z graczami w pobli≈ºu</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                        <i class="fas fa-users"></i>
                    </div>
                    <h4>Multiplayer Online</h4>
                    <p>Graj z graczami z ca≈Çego ≈õwiata</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h4>Czat Tekstowy</h4>
                    <p>Pisz z emotikonami</p>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h4>System Rankingowy</h4>
                    <p>Walcz o pierwsze miejsce</p>
                </div>
            </div>
            
            <div class="game-instructions">
                <div class="instructions-header">
                    <i class="fas fa-gamepad"></i>
                    <h3>Sterowanie</h3>
                </div>
                
                <div class="controls-grid">
                    <div class="control-item">
                        <div class="key-group">
                            <kbd>W</kbd>
                            <kbd>A</kbd>
                            <kbd>S</kbd>
                            <kbd>D</kbd>
                        </div>
                        <span>Ruch kulki</span>
                    </div>
                    
                    <div class="control-item">
                        <div class="key-group">
                            <kbd><i class="fas fa-arrow-up"></i></kbd>
                            <kbd><i class="fas fa-arrow-left"></i></kbd>
                            <kbd><i class="fas fa-arrow-down"></i></kbd>
                            <kbd><i class="fas fa-arrow-right"></i></kbd>
                        </div>
                        <span>Alternatywny ruch</span>
                    </div>
                    
                    <div class="control-item">
                        <kbd class="key-large">V</kbd>
                        <span>M√≥w przez voice chat</span>
                    </div>
                    
                    <div class="control-item">
                        <kbd class="key-large">T</kbd>
                        <span>Otw√≥rz czat tekstowy</span>
                    </div>
                    
                    <div class="control-item">
                        <div class="scroll-icon">
                            <i class="fas fa-mouse"></i>
                            <i class="fas fa-arrows-alt-v"></i>
                        </div>
                        <span>Zoom mapy</span>
                    </div>
                    
                    <div class="control-item">
                        <kbd class="key-large"><i class="fas fa-mouse-pointer"></i></kbd>
                        <span>Kliknij na minimapƒô</span>
                    </div>
                </div>
                
                <div class="game-tip">
                    <i class="fas fa-lightbulb"></i>
                    <p><strong>Nowo≈õƒá:</strong> Przetestuj mikrofon z echem przed grƒÖ! Us≈Çyszysz sw√≥j g≈Ços w czasie rzeczywistym.</p>
                </div>
            </div>
            
            <div class="server-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <div class="status-pulse"></div>
                </div>
                <div class="status-info">
                    <span id="statusText" class="status-text">üü¢ Serwer gotowy</span>
                    <span class="status-subtext">Po≈ÇƒÖcz siƒô z graczami na ca≈Çym ≈õwiecie</span>
                </div>
                <button id="quickTestBtn" class="quick-test-btn">
                    <i class="fas fa-bolt"></i>
                    Test z echem
                </button>
            </div>
            
            <div class="footer-info">
                <div class="version">v3.2 ‚Ä¢ Voice Chat z Testem Echa</div>
                <div class="creator">
                    <i class="fas fa-code"></i>
                    Test z echem w czasie rzeczywistym
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const playBtn = document.getElementById('playBtn');
            const nicknameInput = document.getElementById('nickname');
            const voicePermission = document.getElementById('voicePermission');
            const openMicTestBtn = document.getElementById('openMicTest');
            const quickTestBtn = document.getElementById('quickTestBtn');
            const micTestModal = document.getElementById('micTestModal');
            const closeMicTestBtn = document.getElementById('closeMicTest');
            const finishTestBtn = document.getElementById('finishTest');
            const testSoundBtn = document.getElementById('testSoundBtn');
            const startMicTestBtn = document.getElementById('startMicTest');
            const stopMicTestBtn = document.getElementById('stopMicTest');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeValue = document.getElementById('volumeValue');
            
            // Zmienne dla testu mikrofonu z echem
            let audioContext = null;
            let analyser = null;
            let microphone = null;
            let mediaStream = null;
            let isTesting = false;
            let audioTested = false;
            let micTested = false;
            let gainNode = null;
            
            // Animacja przycisku gry
            playBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px) scale(1.02)';
            });
            
            playBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
            
            // Wyb√≥r koloru
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('.color-check').style.opacity = '0';
                    });
                    this.classList.add('selected');
                    this.querySelector('.color-check').style.opacity = '1';
                    
                    this.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 200);
                });
                
                option.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.transform = 'scale(1.1)';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.transform = 'scale(1)';
                    }
                });
            });
            
            // Wybierz domy≈õlny kolor
            document.querySelectorAll('.color-option')[0].classList.add('selected');
            document.querySelectorAll('.color-option')[0].querySelector('.color-check').style.opacity = '1';
            
            // Rozpoczƒôcie gry
            playBtn.addEventListener('click', function() {
                const nickname = nicknameInput.value.trim();
                const selectedColor = document.querySelector('.color-option.selected')?.dataset.color || '#FF5252';
                const allowVoice = voicePermission.checked;
                
                if (!nickname) {
                    showNotification('Proszƒô wpisaƒá nick!', 'error');
                    nicknameInput.focus();
                    return;
                }
                
                if (nickname.length < 2) {
                    showNotification('Nick musi mieƒá co najmniej 2 znaki!', 'error');
                    nicknameInput.focus();
                    return;
                }
                
                // Animacja klikniƒôcia
                this.style.transform = 'scale(0.95)';
                this.style.opacity = '0.8';
                
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                    this.style.opacity = '1';
                    
                    // Zapisz dane
                    localStorage.setItem('playerData', JSON.stringify({
                        nickname: nickname,
                        color: selectedColor,
                        allowVoice: allowVoice,
                        timestamp: Date.now()
                    }));
                    
                    // Przejd≈∫ do gry
                    window.location.href = 'game.html';
                }, 200);
            });
            
            // Test mikrofonu z echem - otw√≥rz modal
            openMicTestBtn.addEventListener('click', openMicTestModal);
            quickTestBtn.addEventListener('click', openMicTestModal);
            
            // Zamknij modal
            closeMicTestBtn.addEventListener('click', closeMicTestModal);
            finishTestBtn.addEventListener('click', closeMicTestModal);
            
            // Klikniƒôcie poza modalem zamyka go
            micTestModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeMicTestModal();
                }
            });
            
            // Test d≈∫wiƒôku
            testSoundBtn.addEventListener('click', testSound);
            
            // Test mikrofonu z echem
            startMicTestBtn.addEventListener('click', startMicTest);
            stopMicTestBtn.addEventListener('click', stopMicTest);
            
            // Suwak g≈Ço≈õno≈õci echa
            if (volumeSlider) {
                volumeSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    if (volumeValue) {
                        volumeValue.textContent = `${value}%`;
                    }
                    
                    // Zaktualizuj g≈Ço≈õno≈õƒá echa w czasie rzeczywistym
                    if (gainNode && audioContext) {
                        gainNode.gain.value = value / 100;
                    }
                });
            }
            
            // Inicjalizuj paski g≈Ço≈õno≈õci
            initVolumeBars();
            
            function openMicTestModal() {
                micTestModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Resetuj testy
                audioTested = false;
                micTested = false;
                updateSoundTestResult();
                updateFeedbackMessage('Rozpocznij testy aby sprawdziƒá sw√≥j mikrofon z echem', 'info');
                
                // Ukryj kontrolkƒô g≈Ço≈õno≈õci
                const volumeControl = document.getElementById('echoVolumeControl');
                if (volumeControl) {
                    volumeControl.style.display = 'none';
                }
            }
            
            function closeMicTestModal() {
                stopMicTest(); // Zatrzymaj test je≈õli dzia≈Ça
                micTestModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            
            function testSound() {
                try {
                    // Utw√≥rz kontekst audio
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Stw√≥rz oscylator (generator d≈∫wiƒôku)
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    // Ustaw parametry d≈∫wiƒôku
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
                    
                    // Envelope dla d≈∫wiƒôku
                    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    
                    // Po≈ÇƒÖcz wƒôz≈Çy
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    // Zacznij i zatrzymaj d≈∫wiƒôk
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.5);
                    
                    // Oznacz test jako wykonany
                    audioTested = true;
                    updateSoundTestResult();
                    updateFeedbackMessage('‚úÖ Test d≈∫wiƒôku zako≈Ñczony pomy≈õlnie!', 'success');
                    
                    // Przycisk z animacjƒÖ
                    testSoundBtn.innerHTML = '<i class="fas fa-check"></i> Test zako≈Ñczony';
                    testSoundBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                    
                    setTimeout(() => {
                        testSoundBtn.innerHTML = '<i class="fas fa-play"></i> Odtw√≥rz testowy d≈∫wiƒôk';
                        testSoundBtn.style.background = '';
                    }, 2000);
                    
                } catch (error) {
                    console.error('B≈ÇƒÖd testu d≈∫wiƒôku:', error);
                    updateFeedbackMessage('‚ùå B≈ÇƒÖd testu d≈∫wiƒôku. Sprawd≈∫ g≈Ço≈õno≈õƒá systemu.', 'error');
                }
            }
            
            async function startMicTest() {
                try {
                    // Zatrzymaj poprzedni test je≈õli istnieje
                    if (mediaStream) {
                        mediaStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Popro≈õ o dostƒôp do mikrofonu
                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false, // Wy≈ÇƒÖcz echo cancellation dla testu
                            noiseSuppression: true,
                            autoGainControl: true,
                            channelCount: 1
                        }
                    });
                    
                    // Inicjalizuj AudioContext
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Stw√≥rz analizator
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    analyser.smoothingTimeConstant = 0.8;
                    
                    // Stw√≥rz wƒôze≈Ç g≈Ço≈õno≈õci dla wyj≈õcia
                    gainNode = audioContext.createGain();
                    gainNode.gain.value = 0.5; // 50% g≈Ço≈õno≈õci dla komfortu
                    
                    // Pod≈ÇƒÖcz mikrofon do analizatora I do wyj≈õcia (echo)
                    microphone = audioContext.createMediaStreamSource(mediaStream);
                    microphone.connect(analyser);
                    microphone.connect(gainNode);
                    gainNode.connect(audioContext.destination); // Pod≈ÇƒÖcz do g≈Ço≈õnik√≥w
                    
                    // Zmie≈Ñ stan przycisk√≥w
                    startMicTestBtn.disabled = true;
                    stopMicTestBtn.disabled = false;
                    startMicTestBtn.innerHTML = '<i class="fas fa-microphone"></i> Test w trakcie...';
                    startMicTestBtn.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
                    
                    // Poka≈º kontrolkƒô g≈Ço≈õno≈õci
                    const volumeControl = document.getElementById('echoVolumeControl');
                    if (volumeControl) {
                        volumeControl.style.display = 'block';
                    }
                    
                    // Aktualizuj status
                    updateMicStatus('active');
                    updateFeedbackMessage('üó£Ô∏è M√≥w do mikrofonu! Us≈Çyszysz sw√≥j g≈Ços w g≈Ço≈õnikach.', 'info');
                    
                    // Rozpocznij animacjƒô pask√≥w
                    isTesting = true;
                    animateVolumeBars();
                    
                    // Oznacz test jako wykonany
                    micTested = true;
                    
                } catch (error) {
                    console.error('B≈ÇƒÖd dostƒôpu do mikrofonu:', error);
                    updateFeedbackMessage('‚ùå Brak dostƒôpu do mikrofonu. Sprawd≈∫ uprawnienia przeglƒÖdarki.', 'error');
                    updateMicStatus('error');
                }
            }
            
            function stopMicTest() {
                isTesting = false;
                
                // Ukryj kontrolkƒô g≈Ço≈õno≈õci
                const volumeControl = document.getElementById('echoVolumeControl');
                if (volumeControl) {
                    volumeControl.style.display = 'none';
                }
                
                // Zatrzymaj stream
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                
                // Zamknij audio context
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                    gainNode = null;
                }
                
                // Resetuj przyciski
                startMicTestBtn.disabled = false;
                stopMicTestBtn.disabled = true;
                startMicTestBtn.innerHTML = '<i class="fas fa-record-vinyl"></i> Rozpocznij test mikrofonu z echem';
                startMicTestBtn.style.background = '';
                
                // Resetuj paski
                resetVolumeBars();
                
                // Aktualizuj status
                updateMicStatus('inactive');
                
                if (micTested) {
                    updateFeedbackMessage('‚úÖ Test mikrofonu z echem zako≈Ñczony. Mikrofon dzia≈Ça poprawnie!', 'success');
                }
            }
            
            function initVolumeBars() {
                const volumeBars = document.getElementById('volumeBars');
                if (!volumeBars) return;
                
                volumeBars.innerHTML = '';
                
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'volume-bar';
                    bar.style.height = '20px';
                    bar.style.animationDelay = `${i * 0.05}s`;
                    volumeBars.appendChild(bar);
                }
            }
            
            function animateVolumeBars() {
                if (!isTesting || !analyser) return;
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                
                // Oblicz ≈õredni poziom d≈∫wiƒôku
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const average = sum / dataArray.length;
                const volumePercent = Math.min(100, Math.round((average / 128) * 100));
                
                // Aktualizuj poziom d≈∫wiƒôku
                const volumeLevel = document.getElementById('volumeLevel');
                if (volumeLevel) {
                    volumeLevel.textContent = `${volumePercent}%`;
                }
                
                // Aktualizuj paski
                const bars = document.querySelectorAll('.volume-bar');
                const activeBars = Math.min(bars.length, Math.floor((volumePercent / 100) * bars.length));
                
                bars.forEach((bar, index) => {
                    if (index < activeBars) {
                        // Ustaw wysoko≈õƒá i kolor na podstawie poziomu
                        const height = 20 + (index * 2);
                        bar.style.height = `${height}px`;
                        
                        // Kolor gradientu: zielony ‚Üí ≈º√≥≈Çty ‚Üí czerwony
                        if (index < 7) {
                            bar.style.background = '#4CAF50'; // Zielony
                        } else if (index < 14) {
                            bar.style.background = '#FFC107'; // ≈ª√≥≈Çty
                        } else {
                            bar.style.background = '#F44336'; // Czerwony
                        }
                        
                        bar.style.animationPlayState = 'running';
                    } else {
                        bar.style.height = '20px';
                        bar.style.background = '#e0e0e0';
                        bar.style.animationPlayState = 'paused';
                    }
                });
                
                // Kontynuuj animacjƒô
                requestAnimationFrame(animateVolumeBars);
            }
            
            function resetVolumeBars() {
                const bars = document.querySelectorAll('.volume-bar');
                bars.forEach(bar => {
                    bar.style.height = '20px';
                    bar.style.background = '#e0e0e0';
                    bar.style.animationPlayState = 'paused';
                });
                
                const volumeLevel = document.getElementById('volumeLevel');
                if (volumeLevel) {
                    volumeLevel.textContent = '0%';
                }
            }
            
            function updateMicStatus(status) {
                const micStatus = document.getElementById('micStatus');
                if (!micStatus) return;
                
                switch(status) {
                    case 'active':
                        micStatus.innerHTML = '<i class="fas fa-microphone recording-dot"></i> Mikrofon aktywny - m√≥w!';
                        micStatus.style.color = '#4CAF50';
                        break;
                    case 'inactive':
                        micStatus.innerHTML = '<i class="fas fa-microphone-slash"></i> Mikrofon nieaktywny';
                        micStatus.style.color = '#757575';
                        break;
                    case 'error':
                        micStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> B≈ÇƒÖd mikrofonu';
                        micStatus.style.color = '#F44336';
                        break;
                }
            }
            
            function updateSoundTestResult() {
                const resultElement = document.getElementById('soundTestResult');
                if (!resultElement) return;
                
                if (audioTested) {
                    resultElement.innerHTML = '<i class="fas fa-check-circle"></i> ‚úÖ D≈∫wiƒôk dzia≈Ça poprawnie';
                    resultElement.style.color = '#4CAF50';
                    resultElement.style.fontWeight = 'bold';
                } else {
                    resultElement.innerHTML = '<i class="fas fa-headphones"></i> Kliknij przycisk aby sprawdziƒá d≈∫wiƒôk';
                    resultElement.style.color = '#757575';
                    resultElement.style.fontWeight = 'normal';
                }
            }
            
            function updateFeedbackMessage(message, type) {
                const feedbackElement = document.getElementById('feedbackMessage');
                if (!feedbackElement) return;
                
                feedbackElement.innerHTML = `<i class="fas fa-${getIconForType(type)}"></i> ${message}`;
                
                switch(type) {
                    case 'success':
                        feedbackElement.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                        feedbackElement.style.color = 'white';
                        break;
                    case 'error':
                        feedbackElement.style.background = 'linear-gradient(135deg, #F44336 0%, #D32F2F 100%)';
                        feedbackElement.style.color = 'white';
                        break;
                    case 'info':
                        feedbackElement.style.background = 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
                        feedbackElement.style.color = 'white';
                        break;
                    case 'warning':
                        feedbackElement.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
                        feedbackElement.style.color = 'white';
                        break;
                }
            }
            
            function getIconForType(type) {
                switch(type) {
                    case 'success': return 'check-circle';
                    case 'error': return 'exclamation-circle';
                    case 'info': return 'info-circle';
                    case 'warning': return 'exclamation-triangle';
                    default: return 'info-circle';
                }
            }
            
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;
                
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'error' ? '#F44336' : '#4CAF50'};
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            // Enter te≈º zaczyna grƒô
            nicknameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    playBtn.click();
                }
            });
            
            // Auto-focus i wyb√≥r tekstu
            setTimeout(() => {
                nicknameInput.focus();
                nicknameInput.select();
            }, 500);
            
            // Pokazuj liczbƒô znak√≥w
            nicknameInput.addEventListener('input', function() {
                const length = this.value.length;
                const max = 15;
                
                if (length > max - 3) {
                    this.style.borderColor = '#FF9800';
                } else {
                    this.style.borderColor = '#ddd';
                }
            });
            
            // Sprawd≈∫ po≈ÇƒÖczenie z serwerem
            checkServerStatus();
            
            async function checkServerStatus() {
                const statusText = document.getElementById('statusText');
                const statusDot = document.querySelector('.status-dot');
                
                if (!statusText || !statusDot) return;
                
                try {
                    statusText.textContent = "üü° ≈ÅƒÖczenie z serwerem...";
                    statusDot.style.background = '#FFC107';
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    statusText.textContent = "üü¢ Serwer gotowy";
                    statusDot.style.background = '#4CAF50';
                    
                } catch (error) {
                    statusText.textContent = "üî¥ B≈ÇƒÖd po≈ÇƒÖczenia";
                    statusDot.style.background = '#F44336';
                    showNotification('Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z serwerem', 'error');
                }
            }
        });
    </script>
</body>
</html>
